name: github-DOCS

on:
  pull_request:
    branches:
      - master
      - develop

permissions:
  contents: none

jobs:
  docs-check:
    runs-on: [macos-latest]
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a4aa98b93cab29d9b1101a6143fb8bce00e2eac4 # v2.7.1
        with:
          egress-policy: audit

      - name: Install Dependencies
        run: |
          brew install doxygen
          python3 -m pip install sphinx -v "sphinx==6.2.1"
          python3 -m pip install breathe
          python3 -m pip install sphinx-rtd-theme
          sphinx-build --version
          doxygen --version

      - name: checkout_kokkos_kernels
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b # v4.1.4
        with:
          path: kokkos-kernels

      - name: checkout_kokkos
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b # v4.1.4
        with:
          repository: kokkos/kokkos
          ref: develop
          path: kokkos

      - name: configure_kokkos
        run: |
          mkdir -p kokkos/{build,install}
          cd kokkos/build
          cmake \
          -DCMAKE_CXX_FLAGS="-Werror" \
          -DCMAKE_CXX_STANDARD=17 \
          -DCMAKE_INSTALL_PREFIX=$PWD/../install \
          -DKokkos_ENABLE_COMPILER_WARNINGS=ON \
          -DKokkos_ENABLE_DEPRECATED_CODE_3=OFF \
          -DKokkos_ENABLE_TESTS=OFF \
          -DKokkos_ENABLE_DEPRECATED_CODE_4=OFF \
          ..

      - name: build_and_install_kokkos
        working-directory: kokkos/build
        run: make -j2 install

      - name: configure_kokkos_kernels
        run: |
          mkdir -p kokkos-kernels/{build,install}
          cd kokkos-kernels/build
          cmake \
          -DKokkos_DIR=$PWD/../../kokkos/install/lib/cmake/Kokkos \
          -DCMAKE_INSTALL_PREFIX=$PWD/../install \
          -DKokkosKernels_ENABLE_DOCS=ON \
          ..

      - name: build_kokkos_kernels_doxygen
        working-directory: kokkos-kernels/build
        run: |
         echo "Redirecting full output to doxygen.out..."
         make Doxygen > doxygen.out 2>&1 || true
         error_ret=$(grep 'Error' doxygen.out | head -c 1) || true
         if [ ! -z $error_ret ]; then
          echo "---- BEGIN: Summary of errors ---- "
          cat doxygen.out | grep -i 'error:' || true
          echo "---- END: Summary of errors ---- "
          echo
          echo
          echo "---- BEGIN: Summary of warnings ---- "
          cat doxygen.out | grep -i 'warning:' || true
          echo "---- END: Summary of warnings ---- "
          exit 1
         fi

      - name: build_kokkos_kernels_sphinx
        working-directory: kokkos-kernels/build
        run: make Sphinx
